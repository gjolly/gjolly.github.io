[{"ref":"/blog/grub_less/","title":"Boot Linux without Grub","section":"blog","tags":["Linux","Kernel","Boot"],"date":"2021.11.19","body":"Boot Linux without Grub To boot the Linux kernel, most disto use a bootloader and one of the most popular is Grub. But did you know you can directly boot the kernel without using a bootloader?\nDISCLAIMER: This is only for fun and learning, I do not advise anyone to do that on their main system. Be safe, use a VM.\nTo use UEFI with QEMU, just read powersj\u0026rsquo;s excelent blog post.\nFirst, check if your kernel config allows this:\n$ cat /boot/config-${uname -r} | grep EFI_STUB CONFIG_EFI_STUB=y Then, copy the kernel and initrd to the EFI partition:\ncp -v /boot/initrd.img-* /boot/efi/EFI/ cp -v /boot/vmlinuz-$(uname -r) /boot/efi/EFI/vmlinuz-$(uname -r).efi  In theory, you can put those files wherever you want on the EFI partition (Ubuntu uses /EFI/ubuntu for example). Just be carefull about the length of the EFI stub path, see this thread.\n Now we need to find out some information about the system:\n On which device (and partition) is located the root filesystem? On which device and which partition is the EFI partition?  Example:\n$ lsblk -o NAME,MOUNTPOINT,LABEL NAME MOUNTPOINT LABEL fd0 loop0 /snap/core20/1169 loop1 /snap/lxd/21780 loop2 /snap/snapd/13640 sr0 vda ├─vda1 / cloudimg-rootfs ├─vda14 └─vda15 /boot/efi UEFI vdb cidata On this system, the root filesystem is /dev/vda1 and the EFI partition is on the same device /dev/vda on partition number 15.\nNow, let\u0026rsquo;s add a new boot entry in the UEFI boot manager\nefibootmgr --create --disk /dev/vda --part 15 --label grub-less --loader \u0026quot;\\EFI\\vmlinuz-$(uname -r).efi\u0026quot; -u \u0026quot;root=/dev/vda1 initrd=\\\\EFI\\\\initrd.img-$(uname -r) ro console=ttyS0\u0026quot;  efibootmgr is a CLI tool to manipulate the UEFI boot manager (no one could have guessed it :D) --create indicates we want to create a new boot entry --disk specifies the disk containing the bootloader (here the kernel) --part is the partition where the boot loader (here the kernel) is --label is simply the name we want to give to this new boot entry --loader is the actual bootloader we want to call, here it is the kernel we previously copied -u is used to pass arguments to the boot loader. Here we pass the location of initrd and the other usual Kernel command line arguments (check /proc/cmdline to find out which cmdline arguments are currently in use)  The current boot entries can then be checked with: efibootmgr (no args). The new boot entry we just created should already be the first one in the bootorder list.\nReboot!! The system should start directly without going through the Grub menu.\nTroubleshooting If something goes really wrong and the system doesn\u0026rsquo;t boot, use this post to mount the EFI partition locally and simply delete the Kernel\u0026rsquo;s EFI from it. The new entry will just fail to find the EFI stub and fallback to the old boot entry.\nTo delete a boot entry: efibootmgr -b NUM -B\nRefs https://askubuntu.com/a/511019 The main source for this blog post https://www.kubuntuforums.net/showthread.php?60193-Going-GRUB-less-with-UEFI\u0026amp;p=309923\u0026amp;viewfull=1#post309923 An undocumented issue https://powersj.io/posts/ubuntu-qemu-cli/ to know more about how to use QEMU https://docs.kernel.org/admin-guide/efi-stub.html The official kernel doc about this kernel feature https://www.kernel.org/doc/html/v4.14/admin-guide/kernel-parameters.html more about Kernel command line\n"}]