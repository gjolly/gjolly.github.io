<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>The UNIX `who` command | Gauthier Jolly</title>
<meta name=keywords content="Linux,utmp,UNIX"><meta name=description content="Understanding where `who` gets its data"><meta name=author content="Gauthier Jolly"><link rel=canonical href=https://gjolly.fr/blog/who/><link crossorigin=anonymous href=https://gjolly.fr/assets/css/stylesheet.3613efbd0b1772781e8f49935e973cae632a7f61471c05b17be155505ccf87b5.css integrity="sha256-NhPvvQsXcngej0mTXpc8rmMqf2FHHAWxe+FVUFzPh7U=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=https://gjolly.fr/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://gjolly.fr/img/terminal-sign.svg><link rel=icon type=image/png sizes=16x16 href=https://gjolly.fr/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://gjolly.fr/favicon-32x32.png><link rel=apple-touch-icon href=https://gjolly.fr/apple-touch-icon.png><link rel=mask-icon href=https://gjolly.fr/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://gjolly.fr/blog/who/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-Y4G50Q2695"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Y4G50Q2695")}</script><meta property="og:title" content="The UNIX `who` command"><meta property="og:description" content="Understanding where `who` gets its data"><meta property="og:type" content="article"><meta property="og:url" content="https://gjolly.fr/blog/who/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2020-08-31T11:40:00+00:00"><meta property="article:modified_time" content="2020-08-31T11:40:00+00:00"><meta property="og:site_name" content="Gauthier Jolly"><meta name=twitter:card content="summary"><meta name=twitter:title content="The UNIX `who` command"><meta name=twitter:description content="Understanding where `who` gets its data"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Blogs","item":"https://gjolly.fr/blog/"},{"@type":"ListItem","position":2,"name":"The UNIX `who` command","item":"https://gjolly.fr/blog/who/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"The UNIX `who` command","name":"The UNIX \u0060who\u0060 command","description":"Understanding where `who` gets its data","keywords":["Linux","utmp","UNIX"],"articleBody":"While working on a completely different project, I started to ask myself how the who command was working under the hood. In the end, I thought it was a good topic for a blog post.\nWho is who Let’s start with the basics. the who command allows you to list the users currently logged on the system. For example, on my machine:\n$ who gauthier tty2 2020-08-30 15:06 (tty2) gauthier pts/1 2020-08-30 15:06 (tmux(1555).%0) gauthier pts/2 2020-08-30 16:41 (tmux(1555).%6) gauthier pts/4 2020-08-30 15:57 (tmux(1555).%3) It tells me that I am logged on the “physical” terminal tty2 and on three pseudo terminals. Indeed my current session of Gnome Shell is running on tty2 and I have 3 tmux windows open.\nBut where is it getting those information? Probably from a file as everything is a file with Linux, but let’s check which one and how the data is stored there.\nA bit of reverse engineering In order to see what the who command is doing I could try to find the source code and dig into it. But I found it fun to use strace to check what the process was doing instead. Since we are expecting who to read system files, we can only focus on the open syscalls.\n$ strace who 2\u003e\u00261 | grep open openat(AT_FDCWD, \"/etc/ld.so.cache\", O_RDONLY|O_CLOEXEC) = 3 openat(AT_FDCWD, \"/usr/lib/libc.so.6\", O_RDONLY|O_CLOEXEC) = 3 openat(AT_FDCWD, \"/usr/lib/locale/locale-archive\", O_RDONLY|O_CLOEXEC) = 3 openat(AT_FDCWD, \"/var/run/utmp\", O_RDONLY|O_CLOEXEC) = 3 openat(AT_FDCWD, \"/etc/localtime\", O_RDONLY|O_CLOEXEC) = 3 We can quickly filter what is interesting and what is not. The first files two files /etc/ld.so.cache, /usr/lib/libc.so.6 are shared libraries loaded by the process, those are interesting us.\nThen /usr/lib/locale/locale-archive, /var/run/utmp and /etc/localtime are opened. Let’s see what those files are storing.\nWhen exploring this kind of topics, it is always interesting to first search into the man pages before starting browsing the web. The 5th section of the manual is dedicated to “file formats and conventions” and seems a good place to start.\nlocale-archive $ man -wK 5 '/usr/lib/locale/locale-archive' Sends us to locale(5) where we can read:\nThe locale definition file contains all the information that the localedef(1) command needs to convert it into the binary locale data‐base. The page also sends us to locale(7) for more explanation about those informations:\nA locale is a set of language and cultural rules. These cover aspects such as language for messages, different character sets, lexico‐graphic conventions, and so on. A program needs to be able to determine its locale and act accordingly to be portable to different cultures. So the who command read from this file, probably using the setlocale(3) function, to find out how the information should be formated and displayed.\nWe can actually check it:\n$ LC_ALL='fr_FR.utf8' who gauthier tty2 Sep 2 11:38 (:1) gauthier pts/1 Sep 2 12:11 (tmux(2445).%0) gauthier pts/2 Sep 2 12:37 (tmux(2445).%1) gauthier pts/3 Sep 2 13:04 (tmux(2445).%2) Indeed, the date is is not formated the same way!\nlocaltime $ man -wK 5 '/etc/localtime' Sends us to localtime(5) which explains:\nThe /etc/localtime file configures the system-wide timezone of the local system that is used by applications for presentation to the user. Probably who uses this file (or uses a function that is using this file) to print timestamps (columns 4 and 5 of who’s output) using the correct timezone configured by the user.\nutmp Finally comes /var/run/utmp:\n$ man -wK 5 '/var/run/utmp' /usr/share/man/man5/utmp.5.gz Where we can read:\nThe utmp file allows one to discover information about who is currently using the system. There may be more users currently using the system, because not all programs use utmp logging. Great! We found where the who command is getting its data. It would be nice to be able to read this file to get those data without using the who command. Unfortunately:\nThe file is a sequence of utmp structures, declared as follows in (note that this is only one of several definitions around; details depend on the version of libc): At this point we understood what the who command is doing: it is reading /var/run/utmp, parsing the content and formating it nicely. Let’s see if we can reproduce this simple behavior.\nMy own who What we simply need to do is: open /var/run/utmp, read n bytes (where n is the size of the utmp structure), print the info contained in each structure, continue until we reach the end of the file. With a bit of formating, we can even make it look like the original who command.\n#include #include #include #include #include int main() { // set the right locale to display the information nicely setlocale(LC_ALL, \"\"); // open the file FILE * file= fopen(\"/var/run/utmp\", \"rb\"); // just for safety if (file == NULL) { return 1; } // initialize the utmp structure struct utmp entry; // read the entries from the file one by one while (fread(\u0026entry, sizeof(struct utmp), 1, file) != 0) { if (entry.ut_type != USER_PROCESS) continue; // format the date (remember who uses the /etc/localtime?) char date[80]; time_t raw_time = entry.ut_tv.tv_sec; struct tm *ts = localtime(\u0026raw_time); strftime(date, sizeof(date), \"%Y-%m-%d %H:%M\", ts); // print the output for this entry, tries to mock who's output printf(\"%-8s %-12s %s (%s)\\n\", entry.ut_user, entry.ut_line, date, entry.ut_host); } fclose(file); } $ clang -o who who.c $ ./who gauthier tty2 2020-08-31 10:02 (tty2) gauthier pts/1 2020-08-31 10:03 (tmux(2220).%0) gauthier pts/2 2020-08-31 10:08 (tmux(2220).%1) gauthier pts/3 2020-08-31 10:33 (tmux(2220).%5) TADA!\nWe can also check with strace if the behavior is the same:\n$ strace ./who 2\u003e\u00261 | grep -e open openat(AT_FDCWD, \"/etc/ld.so.cache\", O_RDONLY|O_CLOEXEC) = 3 openat(AT_FDCWD, \"/usr/lib/libc.so.6\", O_RDONLY|O_CLOEXEC) = 3 openat(AT_FDCWD, \"/usr/lib/locale/locale-archive\", O_RDONLY|O_CLOEXEC) = 3 openat(AT_FDCWD, \"/var/run/utmp\", O_RDONLY) = 3 openat(AT_FDCWD, \"/etc/localtime\", O_RDONLY|O_CLOEXEC) = 4 Indeed our program is doing the same as the original who.\nOf course, this only mocks the most basic features of the who command and doesn’t handle any option, like the famous who am i or who mom hates.\nGoing further There is still a lot to say about the who command. We could for example mention the lastlog command and its corresponding file /var/log/wtmp, dig into the utmp structure, or just try to understand what utmp stands for.\n","wordCount":"1022","inLanguage":"en","datePublished":"2020-08-31T11:40:00Z","dateModified":"2020-08-31T11:40:00Z","author":{"@type":"Person","name":"Gauthier Jolly"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://gjolly.fr/blog/who/"},"publisher":{"@type":"Organization","name":"Gauthier Jolly","logo":{"@type":"ImageObject","url":"https://gjolly.fr/img/terminal-sign.svg"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://gjolly.fr/ accesskey=h title="Home (Alt + H)"><img src=https://gjolly.fr/apple-touch-icon.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li></ul></div></div><ul id=menu><li><a href=https://gjolly.fr/blog/ title=blog><span>blog</span></a></li><li><a href=https://gjolly.fr/tags/ title=tags><span>tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://gjolly.fr/>Home</a>&nbsp;»&nbsp;<a href=https://gjolly.fr/blog/>Blogs</a></div><h1 class=post-title>The UNIX `who` command</h1><div class=post-description>Understanding where `who` gets its data</div><div class=post-meta>&lt;span title='2020-08-31 11:40:00 +0000 UTC'>August 31, 2020&lt;/span>&amp;nbsp;·&amp;nbsp;1022 words&amp;nbsp;·&amp;nbsp;Gauthier Jolly</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#who-is-who>Who is <code>who</code></a></li><li><a href=#a-bit-of-reverse-engineering>A bit of reverse engineering</a><ul><li><a href=#locale-archive>locale-archive</a></li><li><a href=#localtime>localtime</a></li><li><a href=#utmp>utmp</a></li><li><a href=#my-own-who>My own <code>who</code></a></li><li><a href=#going-further>Going further</a></li></ul></li></ul></nav></div></details></div><div class=post-content><p>While working on a completely different project, I started to ask myself how the <code>who</code> command was working under the hood. In the end, I thought it was a good topic for a blog post.</p><h2 id=who-is-who>Who is <code>who</code><a hidden class=anchor aria-hidden=true href=#who-is-who>#</a></h2><p>Let&rsquo;s start with the basics. the <code>who</code> command allows you to list the users currently logged on the system.
For example, on my machine:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ who
</span></span><span class=line><span class=cl>gauthier tty2         2020-08-30 15:06 <span class=o>(</span>tty2<span class=o>)</span>
</span></span><span class=line><span class=cl>gauthier pts/1        2020-08-30 15:06 <span class=o>(</span>tmux<span class=o>(</span>1555<span class=o>)</span>.%0<span class=o>)</span>
</span></span><span class=line><span class=cl>gauthier pts/2        2020-08-30 16:41 <span class=o>(</span>tmux<span class=o>(</span>1555<span class=o>)</span>.%6<span class=o>)</span>
</span></span><span class=line><span class=cl>gauthier pts/4        2020-08-30 15:57 <span class=o>(</span>tmux<span class=o>(</span>1555<span class=o>)</span>.%3<span class=o>)</span>
</span></span></code></pre></div><p>It tells me that I am logged on the &ldquo;physical&rdquo; terminal <code>tty2</code> and on three pseudo terminals. Indeed my current session of Gnome Shell is running on <code>tty2</code> and I have 3 <code>tmux</code> windows open.</p><p>But where is it getting those information? Probably from a file as everything is a file with Linux, but let&rsquo;s check which one and how the data is stored there.</p><h2 id=a-bit-of-reverse-engineering>A bit of reverse engineering<a hidden class=anchor aria-hidden=true href=#a-bit-of-reverse-engineering>#</a></h2><p>In order to see what the <code>who</code> command is doing I could try to find the source code and dig into it. But I found it fun to use <code>strace</code> to check what the process was doing instead. Since we are expecting <code>who</code> to read system files, we can only focus on the <code>open</code> syscalls.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ strace who 2&gt;<span class=p>&amp;</span><span class=m>1</span> <span class=p>|</span> grep open
</span></span><span class=line><span class=cl>openat<span class=o>(</span>AT_FDCWD, <span class=s2>&#34;/etc/ld.so.cache&#34;</span>, O_RDONLY<span class=p>|</span>O_CLOEXEC<span class=o>)</span> <span class=o>=</span> <span class=m>3</span>
</span></span><span class=line><span class=cl>openat<span class=o>(</span>AT_FDCWD, <span class=s2>&#34;/usr/lib/libc.so.6&#34;</span>, O_RDONLY<span class=p>|</span>O_CLOEXEC<span class=o>)</span> <span class=o>=</span> <span class=m>3</span>
</span></span><span class=line><span class=cl>openat<span class=o>(</span>AT_FDCWD, <span class=s2>&#34;/usr/lib/locale/locale-archive&#34;</span>, O_RDONLY<span class=p>|</span>O_CLOEXEC<span class=o>)</span> <span class=o>=</span> <span class=m>3</span>
</span></span><span class=line><span class=cl>openat<span class=o>(</span>AT_FDCWD, <span class=s2>&#34;/var/run/utmp&#34;</span>, O_RDONLY<span class=p>|</span>O_CLOEXEC<span class=o>)</span> <span class=o>=</span> <span class=m>3</span>
</span></span><span class=line><span class=cl>openat<span class=o>(</span>AT_FDCWD, <span class=s2>&#34;/etc/localtime&#34;</span>, O_RDONLY<span class=p>|</span>O_CLOEXEC<span class=o>)</span> <span class=o>=</span> <span class=m>3</span>
</span></span></code></pre></div><p>We can quickly filter what is interesting and what is not. The first files two files <code>/etc/ld.so.cache</code>, <code>/usr/lib/libc.so.6</code> are shared libraries loaded by the process, those are interesting us.</p><p>Then <code>/usr/lib/locale/locale-archive</code>, <code>/var/run/utmp</code> and <code>/etc/localtime</code> are opened. Let&rsquo;s see what those files are storing.</p><p>When exploring this kind of topics, it is always interesting to first search into the man pages before starting browsing the web. The 5th section of the manual is dedicated to &ldquo;file formats and conventions&rdquo; and seems a good place to start.</p><h3 id=locale-archive>locale-archive<a hidden class=anchor aria-hidden=true href=#locale-archive>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ man -wK <span class=m>5</span> <span class=s1>&#39;/usr/lib/locale/locale-archive&#39;</span>
</span></span></code></pre></div><p>Sends us to <code>locale(5)</code> where we can read:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>The  locale  definition file contains all the information that the localedef<span class=o>(</span>1<span class=o>)</span> <span class=nb>command</span> needs to convert it into the binary locale data‐base.
</span></span></code></pre></div><p>The page also sends us to <code>locale(7)</code> for more explanation about those informations:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>A  locale is a <span class=nb>set</span> of language and cultural rules. These cover aspects such as language <span class=k>for</span> messages, different character sets, lexico‐graphic conventions, and so on. A program needs to be able to determine its locale and act accordingly to be portable to different cultures.
</span></span></code></pre></div><p>So the <code>who</code> command read from this file, probably using the <code>setlocale(3)</code> function, to find out how the information should be formated and displayed.</p><p>We can actually check it:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ <span class=nv>LC_ALL</span><span class=o>=</span><span class=s1>&#39;fr_FR.utf8&#39;</span> who
</span></span><span class=line><span class=cl>gauthier tty2         Sep  <span class=m>2</span> 11:38 <span class=o>(</span>:1<span class=o>)</span>
</span></span><span class=line><span class=cl>gauthier pts/1        Sep  <span class=m>2</span> 12:11 <span class=o>(</span>tmux<span class=o>(</span>2445<span class=o>)</span>.%0<span class=o>)</span>
</span></span><span class=line><span class=cl>gauthier pts/2        Sep  <span class=m>2</span> 12:37 <span class=o>(</span>tmux<span class=o>(</span>2445<span class=o>)</span>.%1<span class=o>)</span>
</span></span><span class=line><span class=cl>gauthier pts/3        Sep  <span class=m>2</span> 13:04 <span class=o>(</span>tmux<span class=o>(</span>2445<span class=o>)</span>.%2<span class=o>)</span>
</span></span></code></pre></div><p>Indeed, the date is is not formated the same way!</p><h3 id=localtime>localtime<a hidden class=anchor aria-hidden=true href=#localtime>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ man -wK <span class=m>5</span> <span class=s1>&#39;/etc/localtime&#39;</span>
</span></span></code></pre></div><p>Sends us to <code>localtime(5)</code> which explains:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>The /etc/localtime file configures the system-wide timezone of the <span class=nb>local</span> system that is used by applications <span class=k>for</span> presentation to the user.
</span></span></code></pre></div><p>Probably <code>who</code> uses this file (or uses a function that is using this file) to print timestamps (columns 4 and 5 of <code>who</code>&rsquo;s output) using the correct timezone configured by the user.</p><h3 id=utmp>utmp<a hidden class=anchor aria-hidden=true href=#utmp>#</a></h3><p>Finally comes <code>/var/run/utmp</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ man -wK <span class=m>5</span> <span class=s1>&#39;/var/run/utmp&#39;</span>
</span></span><span class=line><span class=cl>/usr/share/man/man5/utmp.5.gz
</span></span></code></pre></div><p>Where we can read:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>The  utmp  file  allows  one to discover information about who is currently using the system.  There may be more users currently using the system, because not all programs use utmp logging.
</span></span></code></pre></div><p>Great! We found where the <code>who</code> command is getting its data. It would be nice to be able to read this file to get those data without using the <code>who</code> command. Unfortunately:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>The file is a sequence of utmp structures, declared as follows in &lt;utmp.h&gt; <span class=o>(</span>note that this is only one of several definitions around<span class=p>;</span> details depend on the version of libc<span class=o>)</span>:
</span></span></code></pre></div><p>At this point we understood what the <code>who</code> command is doing: it is reading <code>/var/run/utmp</code>, parsing the content and formating it nicely. Let&rsquo;s see if we can reproduce this simple behavior.</p><h3 id=my-own-who>My own <code>who</code><a hidden class=anchor aria-hidden=true href=#my-own-who>#</a></h3><p>What we simply need to do is: open <code>/var/run/utmp</code>, read <code>n</code> bytes (where <code>n</code> is the size of the <code>utmp</code> structure), print the info contained in each structure, continue until we reach the end of the file. With a bit of formating, we can even make it look like the original <code>who</code> command.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;utmp.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;time.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;locale.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// set the right locale to display the information nicely
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nf>setlocale</span><span class=p>(</span><span class=n>LC_ALL</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// open the file
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>FILE</span> <span class=o>*</span> <span class=n>file</span><span class=o>=</span> <span class=nf>fopen</span><span class=p>(</span><span class=s>&#34;/var/run/utmp&#34;</span><span class=p>,</span> <span class=s>&#34;rb&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// just for safety
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=n>file</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// initialize the utmp structure
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>struct</span> <span class=n>utmp</span> <span class=n>entry</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// read the entries from the file one by one
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>while</span> <span class=p>(</span><span class=nf>fread</span><span class=p>(</span><span class=o>&amp;</span><span class=n>entry</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=k>struct</span> <span class=n>utmp</span><span class=p>),</span> <span class=mi>1</span><span class=p>,</span> <span class=n>file</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>entry</span><span class=p>.</span><span class=n>ut_type</span> <span class=o>!=</span> <span class=n>USER_PROCESS</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// format the date (remember who uses the /etc/localtime?)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>char</span> <span class=n>date</span><span class=p>[</span><span class=mi>80</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=kt>time_t</span> <span class=n>raw_time</span> <span class=o>=</span> <span class=n>entry</span><span class=p>.</span><span class=n>ut_tv</span><span class=p>.</span><span class=n>tv_sec</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>tm</span> <span class=o>*</span><span class=n>ts</span> <span class=o>=</span> <span class=nf>localtime</span><span class=p>(</span><span class=o>&amp;</span><span class=n>raw_time</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>strftime</span><span class=p>(</span><span class=n>date</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>date</span><span class=p>),</span> <span class=s>&#34;%Y-%m-%d %H:%M&#34;</span><span class=p>,</span> <span class=n>ts</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// print the output for this entry, tries to mock who&#39;s output
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;%-8s %-12s %s (%s)</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>entry</span><span class=p>.</span><span class=n>ut_user</span><span class=p>,</span> <span class=n>entry</span><span class=p>.</span><span class=n>ut_line</span><span class=p>,</span> <span class=n>date</span><span class=p>,</span> <span class=n>entry</span><span class=p>.</span><span class=n>ut_host</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nf>fclose</span><span class=p>(</span><span class=n>file</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ clang -o who who.c
</span></span><span class=line><span class=cl>$ ./who
</span></span><span class=line><span class=cl>gauthier tty2         2020-08-31 10:02 <span class=o>(</span>tty2<span class=o>)</span>
</span></span><span class=line><span class=cl>gauthier pts/1        2020-08-31 10:03 <span class=o>(</span>tmux<span class=o>(</span>2220<span class=o>)</span>.%0<span class=o>)</span>
</span></span><span class=line><span class=cl>gauthier pts/2        2020-08-31 10:08 <span class=o>(</span>tmux<span class=o>(</span>2220<span class=o>)</span>.%1<span class=o>)</span>
</span></span><span class=line><span class=cl>gauthier pts/3        2020-08-31 10:33 <span class=o>(</span>tmux<span class=o>(</span>2220<span class=o>)</span>.%5<span class=o>)</span>
</span></span></code></pre></div><p>TADA!</p><p>We can also check with <code>strace</code> if the behavior is the same:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ strace ./who 2&gt;<span class=p>&amp;</span><span class=m>1</span> <span class=p>|</span> grep -e open
</span></span><span class=line><span class=cl>openat<span class=o>(</span>AT_FDCWD, <span class=s2>&#34;/etc/ld.so.cache&#34;</span>, O_RDONLY<span class=p>|</span>O_CLOEXEC<span class=o>)</span> <span class=o>=</span> <span class=m>3</span>
</span></span><span class=line><span class=cl>openat<span class=o>(</span>AT_FDCWD, <span class=s2>&#34;/usr/lib/libc.so.6&#34;</span>, O_RDONLY<span class=p>|</span>O_CLOEXEC<span class=o>)</span> <span class=o>=</span> <span class=m>3</span>
</span></span><span class=line><span class=cl>openat<span class=o>(</span>AT_FDCWD, <span class=s2>&#34;/usr/lib/locale/locale-archive&#34;</span>, O_RDONLY<span class=p>|</span>O_CLOEXEC<span class=o>)</span> <span class=o>=</span> <span class=m>3</span>
</span></span><span class=line><span class=cl>openat<span class=o>(</span>AT_FDCWD, <span class=s2>&#34;/var/run/utmp&#34;</span>, O_RDONLY<span class=o>)</span> <span class=o>=</span> <span class=m>3</span>
</span></span><span class=line><span class=cl>openat<span class=o>(</span>AT_FDCWD, <span class=s2>&#34;/etc/localtime&#34;</span>, O_RDONLY<span class=p>|</span>O_CLOEXEC<span class=o>)</span> <span class=o>=</span> <span class=m>4</span>
</span></span></code></pre></div><p>Indeed our program is doing the same as the original <code>who</code>.</p><p>Of course, this only mocks the most basic features of the <code>who</code> command and doesn&rsquo;t handle any option, like the famous <code>who am i</code> or <code>who mom hates</code>.</p><h3 id=going-further>Going further<a hidden class=anchor aria-hidden=true href=#going-further>#</a></h3><p>There is still a lot to say about the <code>who</code> command. We could for example mention the <code>lastlog</code> command and its corresponding file <code>/var/log/wtmp</code>, dig into the <code>utmp</code> structure, or just try to understand what <code>utmp</code> stands for.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://gjolly.fr/tags/linux/>Linux</a></li><li><a href=https://gjolly.fr/tags/utmp/>Utmp</a></li><li><a href=https://gjolly.fr/tags/unix/>UNIX</a></li></ul><nav class=paginav><a class=prev href=https://gjolly.fr/blog/ufw/><span class=title>« Prev</span><br><span>Firewall, Tailscale and Ubuntu</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://gjolly.fr/>Gauthier Jolly</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>