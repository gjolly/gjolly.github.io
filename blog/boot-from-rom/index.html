<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Boot Linux with coreboot without bootloader | Gauthier Jolly</title>
<meta name=keywords content="Linux,Kernel,Boot,Ubuntu"><meta name=description content="Virtual firmware can be as big as you want, so you can fit a entire kernel."><meta name=author content="Gauthier Jolly"><link rel=canonical href=https://gjolly.fr/blog/boot-from-rom/><link crossorigin=anonymous href=https://gjolly.fr/assets/css/stylesheet.d6fcd20a4fb86efa4dfac8ec95da60244cc8871042183da1ef28e3a762ad79c8.css integrity="sha256-1vzSCk+4bvpN+sjsldpgJEzIhxBCGD2h7yjjp2Ktecg=" rel="preload stylesheet" as=style><link rel=icon href=https://gjolly.fr/img/terminal-sign.svg><link rel=icon type=image/png sizes=16x16 href=https://gjolly.fr/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://gjolly.fr/favicon-32x32.png><link rel=apple-touch-icon href=https://gjolly.fr/apple-touch-icon.png><link rel=mask-icon href=https://gjolly.fr/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://gjolly.fr/blog/boot-from-rom/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-Y4G50Q2695"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Y4G50Q2695")}</script><meta property="og:url" content="https://gjolly.fr/blog/boot-from-rom/"><meta property="og:site_name" content="Gauthier Jolly"><meta property="og:title" content="Boot Linux with coreboot without bootloader"><meta property="og:description" content="Virtual firmware can be as big as you want, so you can fit a entire kernel."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="blog"><meta property="article:published_time" content="2024-10-14T17:10:00+00:00"><meta property="article:modified_time" content="2024-10-14T17:10:00+00:00"><meta property="article:tag" content="Linux"><meta property="article:tag" content="Kernel"><meta property="article:tag" content="Boot"><meta property="article:tag" content="Ubuntu"><meta name=twitter:card content="summary"><meta name=twitter:title content="Boot Linux with coreboot without bootloader"><meta name=twitter:description content="Virtual firmware can be as big as you want, so you can fit a entire kernel."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Blogs","item":"https://gjolly.fr/blog/"},{"@type":"ListItem","position":2,"name":"Boot Linux with coreboot without bootloader","item":"https://gjolly.fr/blog/boot-from-rom/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Boot Linux with coreboot without bootloader","name":"Boot Linux with coreboot without bootloader","description":"Virtual firmware can be as big as you want, so you can fit a entire kernel.","keywords":["Linux","Kernel","Boot","Ubuntu"],"articleBody":"Boot process - context In general, the boot process looks like this:\nROM | DISK Pre-EFI initialization -\u003e EFI firwmare -|\u003e shim -\u003e grub -\u003e Linux The pre-efi initialization is about initializing CPU and devices. Especially, it is responsible for initializing the DRAM controller on the CPU. Before this step the system is in a very precurious state and can only use its cache as memory (aka Cache as RAM).\n“EFI firmware” is misleading as EFI stands for Extensible Firmware Interface and is a specification not a firwmare in itself. The “EFI firmware” is the part of the firmware implementing the EFI specification.\nWhy do we need a firmware? because on hardware devices, the ROM is usually fairly small (a few megabytes) because the firmware in the ROM is owned by the hadware vendor and thus needs to transition to the OS world because Windows 10 requires a EFI firmware to be able to boot But in the VM world where nothing is real, these points are not valid anymore.\nthe firwmare can be as big as we want as there is no physical ROM the VM gets provisioned with a firmware that is provided along with the OS disk, thus OS and firmware are on the same level if you want to boot windows you can just configure your VM to use another firwmare Boot Linux with Coreboot Build coreboot with a bzimage payload Instructions are provided here: https://doc.coreboot.org/tutorial/part1.html\nMake sure to configure the payload to be a bzimage\nyou can simply copy a generic linux kernel vmlinuz from ubuntu make sure compression is un-selected give it a cmdline (eg root=PARTUUID=uuid-for-your-disk-part console=ttyS0 earlyprintk=ttyS0) Make sure to select a QEMU board:\n‘Mainboard vendor’ should be ‘(Emulation)’ ‘Mainboard model’ should be ‘Qemu q35’ Run in qemu Here noble-server-cloudimg-amd64.img is taken from cloud-images.ubuntu.com\nqemu-system-x86_64 \\ -enable-kvm -nographic \\ -cpu host -m 2048 \\ -snapshot \\ -machine q35,max-fw-size=20000000 \\ -drive if=pflash,format=raw,unit=0,file=./coreboot.rom,readonly=on \\ -drive if=virtio,format=qcow2,file=./noble-server-cloudimg-amd64.img ","wordCount":"321","inLanguage":"en","datePublished":"2024-10-14T17:10:00Z","dateModified":"2024-10-14T17:10:00Z","author":{"@type":"Person","name":"Gauthier Jolly"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://gjolly.fr/blog/boot-from-rom/"},"publisher":{"@type":"Organization","name":"Gauthier Jolly","logo":{"@type":"ImageObject","url":"https://gjolly.fr/img/terminal-sign.svg"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://gjolly.fr/ accesskey=h title="Home (Alt + H)"><img src=https://gjolly.fr/apple-touch-icon.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://gjolly.fr/blog/ title=blog><span>blog</span></a></li><li><a href=https://gjolly.fr/tags/ title=tags><span>tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://gjolly.fr/>Home</a>&nbsp;»&nbsp;<a href=https://gjolly.fr/blog/>Blogs</a></div><h1 class="post-title entry-hint-parent">Boot Linux with coreboot without bootloader</h1><div class=post-description>Virtual firmware can be as big as you want, so you can fit a entire kernel.</div><div class=post-meta><span title='2024-10-14 17:10:00 +0000 UTC'>October 14, 2024</span>&nbsp;·&nbsp;321 words&nbsp;·&nbsp;Gauthier Jolly</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#boot-process---context>Boot process - context</a><ul><li><a href=#why-do-we-need-a-firmware>Why do we need a firmware?</a></li></ul></li><li><a href=#boot-linux-with-coreboot>Boot Linux with Coreboot</a><ul><li><a href=#build-coreboot-with-a-bzimage-payload>Build <code>coreboot</code> with a bzimage payload</a></li><li><a href=#run-in-qemu>Run in <code>qemu</code></a></li></ul></li></ul></nav></div></details></div><div class=post-content><h2 id=boot-process---context>Boot process - context<a hidden class=anchor aria-hidden=true href=#boot-process---context>#</a></h2><p>In general, the boot process looks like this:</p><pre tabindex=0><code>                     ROM                |          DISK
Pre-EFI initialization -&gt; EFI firwmare -|&gt; shim -&gt; grub -&gt; Linux
</code></pre><p>The pre-efi initialization is about initializing CPU and devices. Especially, it is responsible for initializing the DRAM controller on the CPU. Before this step the system is in a very precurious state and can only use its cache as memory (aka Cache as RAM).</p><p>&ldquo;EFI firmware&rdquo; is misleading as EFI stands for Extensible Firmware Interface and is a specification not a firwmare in itself. The &ldquo;EFI firmware&rdquo; is the part of the firmware implementing the EFI specification.</p><h3 id=why-do-we-need-a-firmware>Why do we need a firmware?<a hidden class=anchor aria-hidden=true href=#why-do-we-need-a-firmware>#</a></h3><ol><li>because on hardware devices, the ROM is usually fairly small (a few megabytes)</li><li>because the firmware in the ROM is owned by the hadware vendor and thus needs to transition to the OS world</li><li>because Windows 10 requires a EFI firmware to be able to boot</li></ol><p>But in the VM world where nothing is real, these points are not valid anymore.</p><ol><li>the firwmare can be as big as we want as there is no physical ROM</li><li>the VM gets provisioned with a firmware that is provided along with the OS disk, thus OS and firmware are on the same level</li><li>if you want to boot windows you can just configure your VM to use another firwmare</li></ol><h2 id=boot-linux-with-coreboot>Boot Linux with Coreboot<a hidden class=anchor aria-hidden=true href=#boot-linux-with-coreboot>#</a></h2><h3 id=build-coreboot-with-a-bzimage-payload>Build <code>coreboot</code> with a bzimage payload<a hidden class=anchor aria-hidden=true href=#build-coreboot-with-a-bzimage-payload>#</a></h3><p>Instructions are provided here: <a href=https://doc.coreboot.org/tutorial/part1.html>https://doc.coreboot.org/tutorial/part1.html</a></p><p>Make sure to configure the payload to be a bzimage</p><ul><li>you can simply copy a generic linux kernel vmlinuz from ubuntu</li><li>make sure compression is un-selected</li><li>give it a cmdline (eg <code>root=PARTUUID=uuid-for-your-disk-part console=ttyS0 earlyprintk=ttyS0</code>)</li></ul><p>Make sure to select a QEMU board:</p><ul><li>&lsquo;Mainboard vendor&rsquo; should be &lsquo;(Emulation)&rsquo;</li><li>&lsquo;Mainboard model&rsquo; should be &lsquo;Qemu q35&rsquo;</li></ul><h3 id=run-in-qemu>Run in <code>qemu</code><a hidden class=anchor aria-hidden=true href=#run-in-qemu>#</a></h3><p>Here <code>noble-server-cloudimg-amd64.img</code> is taken from <a href=http://cloud-images.ubuntu.com/noble>cloud-images.ubuntu.com</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>qemu-system-x86_64 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -enable-kvm -nographic <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -cpu host -m <span class=m>2048</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -snapshot <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -machine q35,max-fw-size<span class=o>=</span><span class=m>20000000</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -drive <span class=k>if</span><span class=o>=</span>pflash,format<span class=o>=</span>raw,unit<span class=o>=</span>0,file<span class=o>=</span>./coreboot.rom,readonly<span class=o>=</span>on <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -drive <span class=k>if</span><span class=o>=</span>virtio,format<span class=o>=</span>qcow2,file<span class=o>=</span>./noble-server-cloudimg-amd64.img
</span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://gjolly.fr/tags/linux/>Linux</a></li><li><a href=https://gjolly.fr/tags/kernel/>Kernel</a></li><li><a href=https://gjolly.fr/tags/boot/>Boot</a></li><li><a href=https://gjolly.fr/tags/ubuntu/>Ubuntu</a></li></ul><nav class=paginav><a class=prev href=https://gjolly.fr/blog/ubuntu-mkosi/><span class=title>« Prev</span><br><span>Build an Ubuntu Server live image with mkosi</span>
</a><a class=next href=https://gjolly.fr/blog/user_tmp/><span class=title>Next »</span><br><span>User temporary directory</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://gjolly.fr/>Gauthier Jolly</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>