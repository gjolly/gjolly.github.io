<!doctype html><html><head><title>FDE, Secureboot and unified kernel image - Gauthier Jolly</title><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Gauthier Jolly"><link rel="shortcut icon" type=image/x-icon href=/img/terminal-sign.svg><link rel=stylesheet href=/style.min.39acacc5d2051426f655a6b7fbf4786fbd0fd8fffd09322c9b497ef0f7439b3f.css integrity="sha256-OaysxdIFFCb2Vaa3+/R4b70P2P/9CTIsm0l+8PdDmz8="><link rel=stylesheet href=/style-dark.min.0a647fb6c07e04b77b54fa0515d0a683d39ecdb251dba960fe1f966f7ff36fc2.css media="(prefers-color-scheme: dark)" integrity="sha256-CmR/tsB+BLd7VPoFFdCmg9OezbJR26lg/h+Wb3/zb8I="><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.8.1/css/all.css integrity=sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf crossorigin=anonymous><link rel=stylesheet href=/css/custom.css><meta property="og:title" content="FDE, Secureboot and unified kernel image"><meta property="og:description" content="Full Disk Encryption on most Linux distro has a major security flow. Why? How to fix it?"><meta property="og:type" content="article"><meta property="og:url" content="/blog/unified_kernel_sb/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2022-11-13T09:10:00+00:00"><meta property="article:modified_time" content="2022-11-13T09:10:00+00:00"><meta itemprop=name content="FDE, Secureboot and unified kernel image"><meta itemprop=description content="Full Disk Encryption on most Linux distro has a major security flow. Why? How to fix it?"><meta itemprop=datePublished content="2022-11-13T09:10:00+00:00"><meta itemprop=dateModified content="2022-11-13T09:10:00+00:00"><meta itemprop=wordCount content="508"><meta itemprop=keywords content="Linux,Kernel,Boot,Ubuntu,"><meta name=twitter:card content="summary"><meta name=twitter:image content="/img/avatar.jpg"><meta name=twitter:title content="FDE, Secureboot and unified kernel image"><meta name=twitter:description content="Full Disk Encryption on most Linux distro has a major security flow. Why? How to fix it?"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--></head><body><h1>FDE, Secureboot and unified kernel image</h1><header><div class=avatar><img class=avatarMask src=/img/avatar.jpg alt>
<a href><img class=avatar-border src=/img/avatar-border.svg alt></a></div><h2><a class=author href>Gauthier Jolly</a></h2></header><p class=date>November 13, 2022</p><div id=tags><ul><li><a href=/tags/linux/>Linux</a></li><li><a href=/tags/kernel/>Kernel</a></li><li><a href=/tags/boot/>Boot</a></li><li><a href=/tags/ubuntu/>Ubuntu</a></li></ul></div><div id=contentBody><h1 id=full-disk-encryption-secureboot-and-unified-kernel-image>Full Disk Encryption, Secureboot and Unified Kernel Image</h1><p>FDE protect your data at rest and Secureboot makes sure what you boot is trusted. But there is a flow.</p><h2 id=the-flow>The flow</h2><p>In order to decrypt the root filesystem, the kernel uses a initial ram disk (initramfs). The initramfs provides an temporary filesystem from which extra kernel modules can be loaded, it also contains a set of scripts used to boot the system including scripts to decrypt the user&rsquo;s root filesystem.
This initramfs image is a file stored un-encrypted next to the kernel image. However, unlike the kernel image, it is not signed by the kernel publisher as the iniramfs is generated locally and can be modified by the user. Thus, anyone with physical access to the user&rsquo;s drive can inject a malicious initramfs that would log the user&rsquo;s passphrase and thus make FDE useless.</p><h2 id=how-to-fix-it>How to fix it</h2><p>We can bundle the kernel and initramfs together in a single binary and sign this binary locally. Thus, modifying the initramfs would prevent the system from booting.</p><h2 id=in-practice>In practice</h2><p>On systems using <code>mkinitcpio</code> or <code>dracut</code> see this article: <a href=https://wiki.archlinux.org/title/Unified_kernel_image#Preparing_a_unified_kernel_image>https://wiki.archlinux.org/title/Unified_kernel_image#Preparing_a_unified_kernel_image</a>.</p><h3 id=on-ubuntu>On Ubuntu</h3><p>To create the unified EFI binary:</p><pre tabindex=0><code>sudo add-apt-repository ppa:snappy-dev/image
sudo apt-get -y install ubuntu-core-initramfs
sudo ubuntu-core-initramfs create-efi --unsigned --output &#34;kernel.efi.unsigned&#34; \
        --cmdline &#34;$(cut -f 2- -d&#39; &#39; /proc/cmdline)&#34; \
        --kernel &#34;/boot/vmlinuz&#34; \
        --kernelver &#34;$(uname -r)&#34; \
        --initrd &#34;/boot/initrd.img&#34;
</code></pre><p>Create and enroll a new MOK:</p><pre tabindex=0><code># You can let everything as default, or customize the fields, it doesn&#39;t matter
openssl req -new -x509 -newkey rsa:2048 \
        -nodes -days 36500 -outform DER \
        -keyout &#34;MOK.priv&#34; \
        -out &#34;MOK.der&#34;
openssl x509 -in MOK.der -inform DER -outform PEM -out MOK.pem
sudo mokutil --import MOK.der
</code></pre><p>Restart your system and follow the instructions to enroll the key.</p><p>Sign the Kernel EFI:</p><pre tabindex=0><code>sudo sbsign --key MOK.priv --cert MOK.pem kernel.efi.unsigned --output kernel.efi
</code></pre><p>Move it do the ESP (or to the /boot partition), example:</p><pre tabindex=0><code>sudo mv kernel.efi /boot/efi/EFI/ubuntu
</code></pre><p>Add a new boot entry to boot on this kernel, example (make sure to point change <code>--disk</code> and <code>--part</code> to your ESP):</p><pre tabindex=0><code>sudo efibootmgr --create --disk /dev/vda --part 15 --label &#34;Ubuntu $(uname -r)&#34; --loader &#34;\EFI\ubuntu\shimx64.efi&#34; -u &#34;\EFI\ubuntu\kernel.efi&#34;
</code></pre><h2 id=next>Next</h2><p>To make it persistent:</p><p>Make the kernel hook for <code>ubuntu-core-initramfs</code> use your keys:</p><pre tabindex=0><code>sudo mkdir /etc/custom-mok/
sudo mv MOK.priv MOK.pem /etc/custom-mok/
</code></pre><p>and modify the hook itself at <code>/etc/kernel/postinst.d/ubuntu-core-initramfs</code>:</p><pre tabindex=0><code>ubuntu-core-initramfs create-efi --key /etc/custom-mok/MOK.priv --cert /etc/custom-mok/MOK.pem --kernelver $version
</code></pre><p>create two new hooks:</p><pre tabindex=0><code>cat /etc/kernel/postinst.d/zz-update-efi-boot
#!/bin/sh
set -e

version=&#34;$1&#34;

command -v efibootmgr &gt;/dev/null 2&gt;&amp;1 || exit 0

part_dev=&#34;$(blkid | grep &#39;LABEL_FATBOOT=&#34;UEFI&#34;&#39; | cut -f1 -d&#39;:&#39;)&#34;
disk=&#34;/dev/$(lsblk -ndo pkname ${part_dev})&#34;

part_name=${part_dev##/dev/}
part_num=&#34;$(cat /sys/class/block/${part_name}/partition)&#34;

# Let&#39;s not duplicate the entry if it already exist
efibootmgr | grep -q &#34;$version&#34; &amp;&amp; exit 0

echo &#34;adding new EFI boot entry&#34;
efibootmgr -q --create --disk &#34;$disk&#34; --part &#34;$part_num&#34; --label &#34;Ubuntu $version&#34; --loader &#34;\EFI\ubuntu\shimx64.efi&#34; -u &#34;\EFI\ubuntu\kernel.efi-$version&#34;
</code></pre><pre tabindex=0><code>cat /etc/kernel/postrm.d/zz-update-efi-boot
#!/bin/sh
set -e

version=&#34;$1&#34;

command -v efibootmgr &gt;/dev/null 2&gt;&amp;1 || exit 0

BOOT_NUM=$(efibootmgr | grep &#34;$version&#34; | cut -f1 -d&#39;*&#39; | sed &#39;s/Boot\(.*\)/\1/&#39;)

if [ -f &#34;$BOOT_NUM&#34; ]; then
    exit 0
fi

efibootmgr -q -b &#34;$BOOT_NUM&#34; -B
</code></pre><p>and make sure it they are executable.</p></div><footer><p>&copy; 2020 Gauthier Jolly.
Powered by <a href=https://gohugo.io/>Hugo</a>
using the <a href=https://github.com/koirand/pulp/>pulp</a> theme.</p></footer></body></html>